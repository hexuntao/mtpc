---
title: Core API
description: MTPC Core API 参考
---

# Core API

MTPC Core 提供了完整的权限和资源管理 API。

## createMTPC

创建 MTPC 实例。

### 类型定义

```typescript
function createMTPC(config?: MTPCConfig): MTPC
```

### 参数

| 参数 | 类型 | 必填 | 描述 |
|------|------|------|------|
| config | [`MTPCConfig`](#mtpcconfig) | 否 | MTPC 配置 |

### 返回值

返回 [`MTPC`](#mtpc) 实例。

### 示例

```typescript
import { createMTPC } from '@mtpc/core'

const mtpc = createMTPC({
  registry: {
    resources: [userResource, orderResource],
  },
})
```

## MTPCConfig

MTPC 配置接口。

### 类型定义

```typescript
interface MTPCConfig {
  registry?: RegistryConfig
  performance?: PerformanceConfig
  logging?: LoggingConfig
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| registry | [`RegistryConfig`](#registryconfig) | 否 | 注册表配置 |
| performance | [`PerformanceConfig`](#performanceconfig) | 否 | 性能配置 |
| logging | [`LoggingConfig`](#loggingconfig) | 否 | 日志配置 |

### 示例

```typescript
const config: MTPCConfig = {
  registry: {
    resources: [userResource, orderResource],
  },
  performance: {
    enabled: true,
    threshold: 100,
  },
  logging: {
    level: 'debug',
  },
}
```

## MTPC

MTPC 核心类。

### 方法

#### init()

初始化 MTPC 实例。

```typescript
async init(): Promise<void>
```

#### use()

注册插件。

```typescript
use(plugin: Plugin): void
```

#### checkPermission()

检查权限。

```typescript
async checkPermission(
  ctx: Context,
  resource: string,
  action: string,
  options?: CheckPermissionOptions
): Promise<PermissionCheckResult>
```

#### checkPermissions()

批量检查权限。

```typescript
async checkPermissions(
  ctx: Context,
  requests: PermissionRequest[]
): Promise<PermissionCheckResult[]>
```

#### createResource()

创建资源。

```typescript
async createResource(
  ctx: Context,
  resource: string,
  data: Record<string, any>
): Promise<Resource>
```

#### readResource()

读取资源。

```typescript
async readResource(
  ctx: Context,
  resource: string,
  id: string
): Promise<Resource | null>
```

#### updateResource()

更新资源。

```typescript
async updateResource(
  ctx: Context,
  resource: string,
  id: string,
  data: Record<string, any>
): Promise<Resource>
```

#### deleteResource()

删除资源。

```typescript
async deleteResource(
  ctx: Context,
  resource: string,
  id: string
): Promise<void>
```

#### listResources()

列出资源。

```typescript
async listResources(
  ctx: Context,
  resource: string,
  options?: ListOptions
): Promise<Resource[]>
```

## defineResource

定义资源。

### 类型定义

```typescript
function defineResource<T extends z.ZodTypeAny>(
  definition: ResourceDefinition<T>
): Resource<T>
```

### 参数

| 参数 | 类型 | 必填 | 描述 |
|------|------|------|------|
| definition | [`ResourceDefinition`](#resourcedefinition) | 是 | 资源定义 |

### 返回值

返回 [`Resource`](#resource) 实例。

### 示例

```typescript
import { defineResource } from '@mtpc/core'
import { z } from 'zod'

const userResource = defineResource({
  name: 'user',
  schema: z.object({
    id: z.string().uuid(),
    name: z.string(),
    email: z.string().email(),
  }),
})
```

## ResourceDefinition

资源定义接口。

### 类型定义

```typescript
interface ResourceDefinition<T extends z.ZodTypeAny> {
  name: string
  schema: T
  features?: ResourceFeatures
  permissions?: PermissionDefinition[]
  metadata?: ResourceMetadata
  relations?: ResourceRelation[]
  hooks?: ResourceHooks
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| name | `string` | 是 | 资源名称 |
| schema | `z.ZodTypeAny` | 是 | Zod Schema |
| features | [`ResourceFeatures`](#resourcefeatures) | 否 | 资源特性 |
| permissions | [`PermissionDefinition[]`](#permissiondefinition) | 否 | 权限定义 |
| metadata | [`ResourceMetadata`](#resourcemetadata) | 否 | 资源元数据 |
| relations | [`ResourceRelation[]`](#resourcerelation) | 否 | 资源关系 |
| hooks | [`ResourceHooks`](#resourcehooks) | 否 | 资源钩子 |

### 示例

```typescript
const definition: ResourceDefinition = {
  name: 'user',
  schema: userSchema,
  features: {
    creatable: true,
    readable: true,
    updatable: true,
    deletable: true,
    listable: true,
  },
  permissions: [
    { action: 'create', description: '创建用户' },
    { action: 'read', description: '查看用户' },
  ],
}
```

## ResourceFeatures

资源特性接口。

### 类型定义

```typescript
interface ResourceFeatures {
  creatable?: boolean
  readable?: boolean
  updatable?: boolean
  deletable?: boolean
  listable?: boolean
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| creatable | `boolean` | 否 | 是否可创建 |
| readable | `boolean` | 否 | 是否可读取 |
| updatable | `boolean` | 否 | 是否可更新 |
| deletable | `boolean` | 否 | 是否可删除 |
| listable | `boolean` | 否 | 是否可列表 |

### 示例

```typescript
const features: ResourceFeatures = {
  creatable: true,
  readable: true,
  updatable: true,
  deletable: true,
  listable: true,
}
```

## PermissionDefinition

权限定义接口。

### 类型定义

```typescript
interface PermissionDefinition {
  action: string
  description?: string
  scope?: PermissionScope
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| action | `string` | 是 | 操作名称 |
| description | `string` | 否 | 权限描述 |
| scope | [`PermissionScope`](#permissionscope) | 否 | 权限范围 |

### 示例

```typescript
const permission: PermissionDefinition = {
  action: 'create',
  description: '创建用户',
  scope: 'tenant',
}
```

## PermissionScope

权限范围类型。

### 类型定义

```typescript
type PermissionScope = 'global' | 'tenant' | 'department' | 'team' | 'own'
```

### 值

| 值 | 描述 |
|----|------|
| `global` | 全局范围 |
| `tenant` | 租户范围 |
| `department` | 部门范围 |
| `team` | 团队范围 |
| `own` | 自己的范围 |

### 示例

```typescript
const scope: PermissionScope = 'tenant'
```

## ResourceMetadata

资源元数据接口。

### 类型定义

```typescript
interface ResourceMetadata {
  displayName?: string
  pluralName?: string
  description?: string
  icon?: string
  group?: string
  sortOrder?: number
  tags?: string[]
  dataScope?: DataScopeConfig
  softDelete?: SoftDeleteConfig
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| displayName | `string` | 否 | 显示名称 |
| pluralName | `string` | 否 | 复数名称 |
| description | `string` | 否 | 描述 |
| icon | `string` | 否 | 图标 |
| group | `string` | 否 | 分组 |
| sortOrder | `number` | 否 | 排序 |
| tags | `string[]` | 否 | 标签 |
| dataScope | [`DataScopeConfig`](#datascopeconfig) | 否 | 数据范围配置 |
| softDelete | [`SoftDeleteConfig`](#softdeleteconfig) | 否 | 软删除配置 |

### 示例

```typescript
const metadata: ResourceMetadata = {
  displayName: '用户',
  pluralName: '用户列表',
  description: '系统用户管理',
  icon: 'user-icon',
  group: 'user-management',
  sortOrder: 1,
  tags: ['core', 'auth'],
}
```

## ResourceRelation

资源关系接口。

### 类型定义

```typescript
interface ResourceRelation {
  name: string
  type: 'hasOne' | 'hasMany' | 'belongsTo' | 'belongsToMany'
  target: string
  foreignKey: string
  description?: string
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| name | `string` | 是 | 关系名称 |
| type | `string` | 是 | 关系类型 |
| target | `string` | 是 | 目标资源 |
| foreignKey | `string` | 是 | 外键 |
| description | `string` | 否 | 描述 |

### 示例

```typescript
const relation: ResourceRelation = {
  name: 'user',
  type: 'belongsTo',
  target: 'user',
  foreignKey: 'userId',
  description: '所属用户',
}
```

## ResourceHooks

资源钩子接口。

### 类型定义

```typescript
interface ResourceHooks {
  beforeCreate?: HookFn
  afterCreate?: HookFn
  beforeUpdate?: HookFn
  afterUpdate?: HookFn
  beforeDelete?: HookFn
  afterDelete?: HookFn
  filterQuery?: FilterQueryHookFn
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| beforeCreate | [`HookFn`](#hookfn) | 否 | 创建前钩子 |
| afterCreate | [`HookFn`](#hookfn) | 否 | 创建后钩子 |
| beforeUpdate | [`HookFn`](#hookfn) | 否 | 更新前钩子 |
| afterUpdate | [`HookFn`](#hookfn) | 否 | 更新后钩子 |
| beforeDelete | [`HookFn`](#hookfn) | 否 | 删除前钩子 |
| afterDelete | [`HookFn`](#hookfn) | 否 | 删除后钩子 |
| filterQuery | [`FilterQueryHookFn`](#filterqueryhookfn) | 否 | 查询过滤钩子 |

### 示例

```typescript
const hooks: ResourceHooks = {
  beforeCreate: async (ctx, data) => {
    console.log('Before create:', data)
    return data
  },
  afterCreate: async (ctx, result) => {
    console.log('After create:', result)
  },
}
```

## HookFn

钩子函数类型。

### 类型定义

```typescript
type HookFn = (
  ctx: Context,
  data: Record<string, any>
) => Promise<Record<string, any> | void>
```

### 参数

| 参数 | 类型 | 描述 |
|------|------|------|
| ctx | [`Context`](#context) | 上下文 |
| data | `Record<string, any>` | 数据 |

### 返回值

返回修改后的数据或 `void`。

### 示例

```typescript
const beforeCreate: HookFn = async (ctx, data) => {
  data.createdAt = new Date()
  return data
}
```

## FilterQueryHookFn

查询过滤钩子函数类型。

### 类型定义

```typescript
type FilterQueryHookFn = (
  ctx: Context,
  query: any
) => Promise<any>
```

### 参数

| 参数 | 类型 | 描述 |
|------|------|------|
| ctx | [`Context`](#context) | 上下文 |
| query | `any` | 查询对象 |

### 返回值

返回过滤后的查询对象。

### 示例

```typescript
const filterQuery: FilterQueryHookFn = async (ctx, query) => {
  return query.where(eq(orders.tenantId, ctx.tenant.id))
}
```

## Context

上下文接口。

### 类型定义

```typescript
interface Context {
  subject: Subject
  tenant: Tenant
  resource?: Resource
  metadata?: Record<string, any>
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| subject | [`Subject`](#subject) | 是 | 主体 |
| tenant | [`Tenant`](#tenant) | 是 | 租户 |
| resource | [`Resource`](#resource) | 否 | 资源 |
| metadata | `Record<string, any>` | 否 | 元数据 |

### 示例

```typescript
const ctx: Context = {
  subject: { id: 'user-1', roles: ['admin'] },
  tenant: { id: 'tenant-1' },
  metadata: { requestId: 'req-1' },
}
```

## Subject

主体接口。

### 类型定义

```typescript
interface Subject {
  id: string
  roles: string[]
  attributes?: Record<string, any>
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| id | `string` | 是 | 主体 ID |
| roles | `string[]` | 是 | 角色列表 |
| attributes | `Record<string, any>` | 否 | 属性 |

### 示例

```typescript
const subject: Subject = {
  id: 'user-1',
  roles: ['admin', 'user'],
  attributes: { department: 'engineering' },
}
```

## Tenant

租户接口。

### 类型定义

```typescript
interface Tenant {
  id: string
  name?: string
  metadata?: Record<string, any>
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| id | `string` | 是 | 租户 ID |
| name | `string` | 否 | 租户名称 |
| metadata | `Record<string, any>` | 否 | 元数据 |

### 示例

```typescript
const tenant: Tenant = {
  id: 'tenant-1',
  name: 'Acme Corp',
  metadata: { plan: 'enterprise' },
}
```

## PermissionCheckResult

权限检查结果接口。

### 类型定义

```typescript
interface PermissionCheckResult {
  allowed: boolean
  explanation?: Explanation
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| allowed | `boolean` | 是 | 是否允许 |
| explanation | [`Explanation`](#explanation) | 否 | 解释 |

### 示例

```typescript
const result: PermissionCheckResult = {
  allowed: true,
  explanation: {
    decision: 'allow',
    reason: 'User has admin role',
  },
}
```

## Explanation

解释接口。

### 类型定义

```typescript
interface Explanation {
  decision: 'allow' | 'deny'
  reason: string
  path?: ExplanationStep[]
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| decision | `string` | 是 | 决策 |
| reason | `string` | 是 | 原因 |
| path | [`ExplanationStep[]`](#explanationstep) | 否 | 路径 |

### 示例

```typescript
const explanation: Explanation = {
  decision: 'allow',
  reason: 'User has admin role',
  path: [
    { step: 'check_policies', result: 'allow' },
  ],
}
```

---

**继续学习：** [RBAC API](/docs/api/rbac) →
