---
title: Drizzle Adapter API
description: MTPC Drizzle Adapter API 参考
---

# Drizzle Adapter API

MTPC Drizzle Adapter 提供了与 Drizzle ORM 的集成。

## createDrizzleAdapter

创建 Drizzle 适配器。

### 类型定义

```typescript
function createDrizzleAdapter(config: DrizzleAdapterConfig): DrizzleAdapter
```

### 参数

| 参数 | 类型 | 必填 | 描述 |
|------|------|------|------|
| config | [`DrizzleAdapterConfig`](#drizzleadapterconfig) | 是 | Drizzle 适配器配置 |

### 返回值

返回 [`DrizzleAdapter`](#drizzleadapter) 实例。

### 示例

```typescript
import { createDrizzleAdapter } from '@mtpc/adapter-drizzle'
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'

const db = drizzle(postgres(process.env.DATABASE_URL))

const adapter = createDrizzleAdapter({
  db,
  schema: {
    users,
    orders,
    products,
  },
})
```

## DrizzleAdapterConfig

Drizzle 适配器配置接口。

### 类型定义

```typescript
interface DrizzleAdapterConfig {
  db: NodePgDatabase
  schema: SchemaMap
  repository?: RepositoryConfig
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| db | `NodePgDatabase` | 是 | Drizzle 数据库实例 |
| schema | [`SchemaMap`](#schemamap) | 是 | Schema 映射 |
| repository | [`RepositoryConfig`](#repositoryconfig) | 否 | 仓库配置 |

### 示例

```typescript
const config: DrizzleAdapterConfig = {
  db,
  schema: {
    users,
    orders,
    products,
  },
  repository: {
    cache: {
      enabled: true,
      ttl: 300,
    },
  },
}
```

## DrizzleAdapter

Drizzle 适配器类。

### 方法

#### create()

创建资源。

```typescript
async create<T>(
  resource: string,
  data: Record<string, any>
): Promise<T>
```

#### read()

读取资源。

```typescript
async read<T>(
  resource: string,
  id: string
): Promise<T | null>
```

#### update()

更新资源。

```typescript
async update<T>(
  resource: string,
  id: string,
  data: Record<string, any>
): Promise<T>
```

#### delete()

删除资源。

```typescript
async delete(
  resource: string,
  id: string
): Promise<void>
```

#### list()

列出资源。

```typescript
async list<T>(
  resource: string,
  options?: ListOptions
): Promise<T[]>
```

#### count()

统计资源。

```typescript
async count(
  resource: string,
  options?: ListOptions
): Promise<number>
```

## SchemaMap

Schema 映射接口。

### 类型定义

```typescript
interface SchemaMap {
  [key: string]: PgTable
}
```

### 示例

```typescript
const schemaMap: SchemaMap = {
  users,
  orders,
  products,
}
```

## RepositoryConfig

仓库配置接口。

### 类型定义

```typescript
interface RepositoryConfig {
  cache?: CacheConfig
  softDelete?: SoftDeleteConfig
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| cache | [`CacheConfig`](#cacheconfig) | 否 | 缓存配置 |
| softDelete | [`SoftDeleteConfig`](#softdeleteconfig) | 否 | 软删除配置 |

### 示例

```typescript
const repositoryConfig: RepositoryConfig = {
  cache: {
    enabled: true,
    ttl: 300,
  },
  softDelete: {
    enabled: true,
    deletedAtColumn: 'deleted_at',
  },
}
```

## CacheConfig

缓存配置接口。

### 类型定义

```typescript
interface CacheConfig {
  enabled?: boolean
  ttl?: number
  maxSize?: number
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| enabled | `boolean` | 否 | 是否启用缓存 |
| ttl | `number` | 否 | 缓存过期时间（秒） |
| maxSize | `number` | 否 | 最大缓存数量 |

### 示例

```typescript
const cacheConfig: CacheConfig = {
  enabled: true,
  ttl: 300,
  maxSize: 1000,
}
```

## SoftDeleteConfig

软删除配置接口。

### 类型定义

```typescript
interface SoftDeleteConfig {
  enabled?: boolean
  deletedAtColumn?: string
  deletedByColumn?: string
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| enabled | `boolean` | 否 | 是否启用软删除 |
| deletedAtColumn | `string` | 否 | 删除时间列名 |
| deletedByColumn | `string` | 否 | 删除人列名 |

### 示例

```typescript
const softDeleteConfig: SoftDeleteConfig = {
  enabled: true,
  deletedAtColumn: 'deleted_at',
  deletedByColumn: 'deleted_by',
}
```

## ListOptions

列表选项接口。

### 类型定义

```typescript
interface ListOptions {
  filter?: Record<string, any>
  sort?: SortOption[]
  pagination?: PaginationOptions
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| filter | `Record<string, any>` | 否 | 过滤条件 |
| sort | [`SortOption[]`](#sortoption) | 否 | 排序选项 |
| pagination | [`PaginationOptions`](#paginationoptions) | 否 | 分页选项 |

### 示例

```typescript
const options: ListOptions = {
  filter: { status: 'active' },
  sort: [{ field: 'createdAt', order: 'desc' }],
  pagination: { page: 1, pageSize: 10 },
}
```

## SortOption

排序选项接口。

### 类型定义

```typescript
interface SortOption {
  field: string
  order: 'asc' | 'desc'
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| field | `string` | 是 | 字段名 |
| order | `string` | 是 | 排序方向 |

### 示例

```typescript
const sortOption: SortOption = {
  field: 'createdAt',
  order: 'desc',
}
```

## PaginationOptions

分页选项接口。

### 类型定义

```typescript
interface PaginationOptions {
  page?: number
  pageSize?: number
  offset?: number
  limit?: number
}
```

### 属性

| 属性 | 类型 | 必填 | 描述 |
|------|------|------|------|
| page | `number` | 否 | 页码 |
| pageSize | `number` | 否 | 每页数量 |
| offset | `number` | 否 | 偏移量 |
| limit | `number` | 否 | 限制数量 |

### 示例

```typescript
const paginationOptions: PaginationOptions = {
  page: 1,
  pageSize: 10,
}
```

## generateSchema

生成数据库 Schema。

### 类型定义

```typescript
function generateSchema(
  registry: ResourceRegistry
): SchemaMap
```

### 参数

| 参数 | 类型 | 必填 | 描述 |
|------|------|------|------|
| registry | [`ResourceRegistry`](#resourceregistry) | 是 | 资源注册表 |

### 返回值

返回 [`SchemaMap`](#schemamap)。

### 示例

```typescript
import { generateSchema } from '@mtpc/adapter-drizzle'

const schema = generateSchema(mtpc.registry)
```

## ResourceRegistry

资源注册表接口。

### 类型定义

```typescript
interface ResourceRegistry {
  register(resource: Resource): void
  get(name: string): Resource | null
  getAll(): Resource[]
}
```

### 方法

| 方法 | 返回值 | 描述 |
|------|--------|------|
| register | `void` | 注册资源 |
| get | `Resource \| null` | 获取资源 |
| getAll | `Resource[]` | 获取所有资源 |

### 示例

```typescript
const registry: ResourceRegistry = {
  register(resource: Resource): void {
    // 注册资源逻辑
  },
  get(name: string): Resource | null {
    // 获取资源逻辑
    return resource
  },
  getAll(): Resource[] {
    // 获取所有资源逻辑
    return resources
  },
}
```

## Repository

仓库接口。

### 类型定义

```typescript
interface Repository<T> {
  create(data: Record<string, any>): Promise<T>
  read(id: string): Promise<T | null>
  update(id: string, data: Record<string, any>): Promise<T>
  delete(id: string): Promise<void>
  list(options?: ListOptions): Promise<T[]>
  count(options?: ListOptions): Promise<number>
}
```

### 方法

| 方法 | 返回值 | 描述 |
|------|--------|------|
| create | `Promise<T>` | 创建记录 |
| read | `Promise<T \| null>` | 读取记录 |
| update | `Promise<T>` | 更新记录 |
| delete | `Promise<void>` | 删除记录 |
| list | `Promise<T[]>` | 列出记录 |
| count | `Promise<number>` | 统计记录 |

### 示例

```typescript
class UserRepository implements Repository<User> {
  async create(data: Record<string, any>): Promise<User> {
    const [user] = await db.insert(users).values(data).returning()
    return user
  }

  async read(id: string): Promise<User | null> {
    const [user] = await db.select().from(users).where(eq(users.id, id))
    return user || null
  }

  async update(id: string, data: Record<string, any>): Promise<User> {
    const [user] = await db.update(users)
      .set(data)
      .where(eq(users.id, id))
      .returning()
    return user
  }

  async delete(id: string): Promise<void> {
    await db.delete(users).where(eq(users.id, id))
  }

  async list(options?: ListOptions): Promise<User[]> {
    let query = db.select().from(users)
    
    if (options?.filter) {
      query = query.where(eq(users.status, options.filter.status))
    }
    
    return query
  }

  async count(options?: ListOptions): Promise<number> {
    let query = db.select({ count: count() }).from(users)
    
    if (options?.filter) {
      query = query.where(eq(users.status, options.filter.status))
    }
    
    const [result] = await query
    return result.count
  }
}
```

---

**继续学习：** [常见问题](/docs/troubleshooting/faq) →
