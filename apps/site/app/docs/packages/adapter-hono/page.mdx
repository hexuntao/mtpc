---
title: mtpc/adapter-hono Hono 框架适配器
description: 详细介绍 Hono 适配器的功能、API 和使用方法
---

# @mtpc/adapter-hono Hono 框架适配器

`@mtpc/adapter-hono` 提供将 MTPC 多租户权限核心集成到 Hono 应用中的完整解决方案。

## 包概述

### 职责和定位

- 提供完整的 Hono 应用创建工厂函数
- 提供租户、认证、权限等中间件
- 自动生成 CRUD 路由
- 提供 RPC 路由支持
- 提供错误处理机制

### 为什么选择 Hono

- **轻量级**：极小的包体积，快速的启动时间
- **类型安全**：完整的 TypeScript 支持
- **中间件优先**：强大的中间件系统
- **高性能**：基于 Web 标准，性能优异
- **Edge 兼容**：支持 Cloudflare Workers、Vercel Edge 等

### 依赖关系

```json
{
  "dependencies": {
    "@mtpc/core": "workspace:*",
    "@mtpc/shared": "workspace:*",
    "hono": "^4.4.0",
    "zod": "^3.23.0"
  },
  "peerDependencies": {
    "hono": "^4.0.0"
  }
}
```

### 安装方法

```bash
npm install @mtpc/adapter-hono hono
```

## 核心功能

### 中间件系统

#### tenantMiddleware（租户中间件）

从请求中提取租户信息并注入到上下文。

```ts
import { tenantMiddleware } from '@mtpc/adapter-hono'

app.use('*', tenantMiddleware({
  headerName: 'x-tenant-id',
  required: true,
}))
```

**配置选项：**

```ts
interface TenantMiddlewareOptions {
  headerName?: string;      // 默认 'x-tenant-id'
  required?: boolean;       // 默认 true
  validate?: (tenant: TenantContext) => Promise<boolean> | boolean;
}
```

#### authMiddleware（认证中间件）

从请求中提取用户信息并注入到上下文。

```ts
import { authMiddleware } from '@mtpc/adapter-hono'

app.use('*', authMiddleware({
  headerName: 'x-subject-id',
  roleHeaderName: 'x-subject-roles',
  required: true,
}))
```

**配置选项：**

```ts
interface AuthMiddlewareOptions {
  headerName?: string;              // 默认 'x-subject-id'
  roleHeaderName?: string;          // 默认 'x-subject-roles'
  required?: boolean;               // 默认 false
  resolver?: (c: Context<MTPCEnv>) => Promise<SubjectContext | null> | SubjectContext | null;
}
```

#### mtpcMiddleware（MTPC 核心中间件）

注入 MTPC 实例到上下文。

```ts
import { mtpcMiddleware } from '@mtpc/adapter-hono'

app.use('*', mtpcMiddleware(mtpc))
```

### 路由系统

#### CRUD 路由自动生成

根据资源定义自动生成 CRUD 路由。

```ts
import { createRPCRoutes } from '@mtpc/adapter-hono'

const routes = createRPCRoutes(mtpc, handlerFactory)
app.route('/api', routes)
```

**生成的路由：**

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/:resource` | 列出资源 |
| GET | `/api/:resource/:id` | 获取单个资源 |
| POST | `/api/:resource` | 创建资源 |
| PUT | `/api/:resource/:id` | 更新资源 |
| DELETE | `/api/:resource/:id` | 删除资源 |

#### RPC 路由

提供 RPC 风格的路由接口。

```ts
import { createRPCRoutes } from '@mtpc/adapter-hono'

const routes = createRPCRoutes(mtpc, handlerFactory)
app.route('/api/rpc', routes)
```

#### 自定义路由

支持自定义路由和权限控制。

```ts
import { permissionMiddleware } from '@mtpc/adapter-hono'

app.get('/api/custom', 
  permissionMiddleware({ resource: 'user', action: 'read' }),
  async (c) => {
    const tenant = c.get('tenant')
    const subject = c.get('subject')
    // 自定义逻辑
    return c.json({ data: 'custom response' })
  }
)
```

### 错误处理

#### mtpcErrorHandler

统一的错误处理中间件。

```ts
import { mtpcErrorHandler } from '@mtpc/adapter-hono'

app.onError(mtpcErrorHandler({
  includeStack: false,
  isProduction: process.env.NODE_ENV === 'production',
}))
```

**配置选项：**

```ts
interface ErrorHandlerOptions {
  includeStack?: boolean;       // 默认 false
  onError?: (err: Error, c: Context) => Promise<void> | void;
  isProduction?: boolean;        // 默认根据 NODE_ENV 判断
  logger?: (error: Error, context: string) => void;
}
```

#### notFoundHandler

404 错误处理。

```ts
import { notFoundHandler } from '@mtpc/adapter-hono'

app.notFound(notFoundHandler)
```

## API 参考

### createMTPCApp() - 创建完整应用

创建包含所有中间件和路由的完整 Hono 应用。

```ts
function createMTPCApp<T = unknown>(
  mtpc: MTPC,
  options?: MTPCAppOptions
): Hono<MTPCEnv>
```

**配置选项：**

```ts
interface MTPCAppOptions {
  prefix?: string;                  // 默认 '/api'
  cors?: boolean | Record<string, unknown>;
  logging?: boolean;                 // 默认 true
  errorHandling?: boolean;            // 默认 true
  tenantOptions?: TenantMiddlewareOptions;
  authOptions?: AuthMiddlewareOptions;
  handlerFactory?: <T>(resource: ResourceDefinition) => CRUDHandlers<T>;
}
```

**示例：**

```ts
import { createMTPC } from '@mtpc/core'
import { createRBACPlugin } from '@mtpc/rbac'
import { createMTPCApp } from '@mtpc/adapter-hono'

// 创建 RBAC 插件
const rbacPlugin = createRBACPlugin()

// 创建 MTPC 实例
const mtpc = createMTPC({
  defaultPermissionResolver: rbacPlugin.state.evaluator.getPermissions.bind(rbacPlugin.state.evaluator)
})

mtpc.use(rbacPlugin)
await mtpc.init()

// 创建 Hono 应用
const app = createMTPCApp(mtpc, {
  prefix: '/api',
  logging: true,
  errorHandling: true,
  tenantOptions: { headerName: 'x-tenant-id' },
  authOptions: { required: true }
})

export default app
```

### createMinimalMTPCApp() - 创建最小化应用

仅包含中间件，不包含自动路由。

```ts
function createMinimalMTPCApp(
  mtpc: MTPC,
  options?: Pick<MTPCAppOptions, 'tenantOptions' | 'authOptions'>
): Hono<MTPCEnv>
```

**示例：**

```ts
const app = createMinimalMTPCApp(mtpc, {
  tenantOptions: { headerName: 'x-tenant-id' },
  authOptions: { required: true }
})

// 手动添加路由
app.get('/custom', handler)
app.post('/custom', handler)
```

### mountMTPC() - 挂载到现有应用

将 MTPC 功能挂载到现有 Hono 应用。

```ts
function mountMTPC<T = unknown>(
  app: Hono<MTPCEnv>,
  mtpc: MTPC,
  options?: MountMTPCOptions
): Hono<MTPCEnv>
```

**配置选项：**

```ts
interface MountMTPCOptions {
  prefix?: string;
  handlerFactory?: <T>(resource: ResourceDefinition) => CRUDHandlers<T>;
  tenantOptions?: TenantMiddlewareOptions;
  authOptions?: AuthMiddlewareOptions;
}
```

**示例：**

```ts
import { Hono } from 'hono'
import { createMTPC } from '@mtpc/core'
import { mountMTPC } from '@mtpc/adapter-hono'

const app = new Hono()

// 添加自定义路由
app.get('/', (c) => c.text('Hello'))

// 挂载 MTPC 路由到 /api 路径
mountMTPC(app, mtpc, { prefix: '/api' })

export default app
```

## 认证方式

### Header 认证

通过请求头传递用户信息。

```ts
import { authMiddleware } from '@mtpc/adapter-hono'

app.use('*', authMiddleware({
  headerName: 'x-subject-id',
  roleHeaderName: 'x-subject-roles',
  required: true,
}))
```

**请求头：**

```
x-subject-id: user-123
x-subject-roles: admin,editor
x-tenant-id: tenant-001
```

### Bearer Token 认证

使用 Bearer Token 进行认证。

```ts
import { bearerAuthMiddleware } from '@mtpc/adapter-hono'

app.use('*', bearerAuthMiddleware({
  verifyToken: async (token) => {
    // 验证 Token 并返回主体信息
    const user = await verifyJWTToken(token)
    return {
      id: user.id,
      type: 'user',
      roles: user.roles,
    }
  },
  required: true,
}))
```

### API Key 认证

使用 API Key 进行认证。

```ts
import { apiKeyAuthMiddleware } from '@mtpc/adapter-hono'

app.use('*', apiKeyAuthMiddleware({
  headerName: 'x-api-key',
  verifyApiKey: async (apiKey) => {
    // 验证 API Key 并返回主体信息
    const user = await verifyAPIKey(apiKey)
    return {
      id: user.id,
      type: 'user',
      roles: user.roles,
    }
  },
  required: true,
}))
```

### 自定义认证解析器

```ts
import { authMiddleware } from '@mtpc/adapter-hono'

app.use('*', authMiddleware({
  resolver: async (c) => {
    // 从 Cookie、Session 等解析用户信息
    const token = c.req.header('cookie')
    const user = await verifyCookie(token)
    
    return {
      id: user.id,
      type: 'user',
      roles: user.roles,
      permissions: user.permissions,
    }
  },
  required: true,
}))
```

## 上下文管理

### MTPCEnv 类型

```ts
interface MTPCEnv extends Env {
  Variables: MTPCVariables;
}
```

### MTPCVariables 接口

```ts
interface MTPCVariables {
  tenant: TenantContext;
  subject: SubjectContext;
  mtpcContext: MTPCContext;
  mtpc: MTPC;
}
```

### 上下文变量访问

```ts
app.get('/api/users', async (c) => {
  // 访问租户上下文
  const tenant = c.get('tenant')
  
  // 访问主体上下文
  const subject = c.get('subject')
  
  // 访问 MTPC 实例
  const mtpc = c.get('mtpc')
  
  // 访问 MTPC 上下文
  const mtpcContext = c.get('mtpcContext')
  
  return c.json({
    tenantId: tenant.id,
    subjectId: subject.id,
  })
})
```

## CRUD 处理器

### CRUDHandlers 接口

```ts
interface CRUDHandlers<T = unknown> {
  list?: (ctx: MTPCContext, options: QueryOptions) => Promise<PaginatedResult<T>>;
  create?: (ctx: MTPCContext, data: unknown) => Promise<T>;
  read?: (ctx: MTPCContext, id: string) => Promise<T | null>;
  update?: (ctx: MTPCContext, id: string, data: unknown) => Promise<T | null>;
  delete?: (ctx: MTPCContext, id: string) => Promise<boolean>;
}
```

### createInMemoryHandlerFactory()

创建内存存储的处理器工厂。

```ts
import { createInMemoryHandlerFactory } from '@mtpc/adapter-hono'

const handlerFactory = createInMemoryHandlerFactory()
```

### 自定义处理器工厂

```ts
const customHandlerFactory = <T>(resource: ResourceDefinition): CRUDHandlers<T> => {
  return {
    async list(ctx, options) {
      // 自定义列表逻辑
      return await db.query(resource.name, options)
    },
    async create(ctx, data) {
      // 自定义创建逻辑
      return await db.insert(resource.name, data)
    },
    async read(ctx, id) {
      // 自定义读取逻辑
      return await db.findById(resource.name, id)
    },
    async update(ctx, id, data) {
      // 自定义更新逻辑
      return await db.update(resource.name, id, data)
    },
    async delete(ctx, id) {
      // 自定义删除逻辑
      return await db.delete(resource.name, id)
    },
  }
}
```

## 使用示例

### 创建完整的 Hono 应用

```ts
import { createMTPC } from '@mtpc/core'
import { createRBACPlugin } from '@mtpc/rbac'
import { createMTPCApp } from '@mtpc/adapter-hono'

// 创建 RBAC 插件
const rbacPlugin = createRBACPlugin()

// 创建 MTPC 实例
const mtpc = createMTPC({
  defaultPermissionResolver: rbacPlugin.state.evaluator.getPermissions.bind(rbacPlugin.state.evaluator)
})

mtpc.use(rbacPlugin)
await mtpc.init()

// 创建 Hono 应用
const app = createMTPCApp(mtpc, {
  prefix: '/api',
  logging: true,
  errorHandling: true,
  tenantOptions: { headerName: 'x-tenant-id' },
  authOptions: { required: true }
})

export default app
```

### 添加自定义路由

```ts
import { createMTPC } from '@mtpc/core'
import { createMinimalMTPCApp, permissionMiddleware } from '@mtpc/adapter-hono'

const mtpc = createMTPC()
await mtpc.init()

const app = createMinimalMTPCApp(mtpc, {
  tenantOptions: { headerName: 'x-tenant-id' },
  authOptions: { required: true }
})

// 添加自定义路由
app.get('/api/custom', 
  permissionMiddleware({ resource: 'user', action: 'read' }),
  async (c) => {
    return c.json({ success: true, data: 'custom response' })
  }
)

export default app
```

### 实现自定义认证

```ts
import { createMTPC } from '@mtpc/core'
import { createMinimalMTPCApp, authMiddleware } from '@mtpc/adapter-hono'

const mtpc = createMTPC()
await mtpc.init()

const app = createMinimalMTPCApp(mtpc, {
  authOptions: {
    resolver: async (c) => {
      const token = c.req.header('authorization')?.replace('Bearer ', '')
      const user = await verifyJWT(token)
      
      return {
        id: user.id,
        type: 'user',
        roles: user.roles,
      }
    },
    required: true,
  },
})

export default app
```

### 集成 RBAC

```ts
import { createMTPC } from '@mtpc/core'
import { createRBACPlugin } from '@mtpc/rbac'
import { createMTPCApp } from '@mtpc/adapter-hono'

// 创建 RBAC 插件
const rbacPlugin = createRBACPlugin({
  cacheTTL: 300000,
})

// 创建 MTPC 实例并集成
const mtpc = createMTPC({
  defaultPermissionResolver: rbacPlugin.state.evaluator.getPermissions.bind(rbacPlugin.state.evaluator)
})

mtpc.use(rbacPlugin)
await mtpc.init()

// 创建 Hono 应用
const app = createMTPCApp(mtpc, {
  prefix: '/api',
})

export default app
```

## 最佳实践

### 中间件顺序

推荐中间件顺序：

```ts
app.use('*', mtpcMiddleware(mtpc))      // 1. MTPC 核心
app.use('*', tenantMiddleware(options))  // 2. 租户解析
app.use('*', authMiddleware(options))    // 3. 认证解析
```

### 错误处理策略

1. **统一错误格式**：使用 `ApiResponse` 类型
2. **生产环境隐藏堆栈**：设置 `isProduction: true`
3. **记录错误日志**：配置 `logger` 选项
4. **自定义错误处理**：使用 `onError` 回调

### 性能优化

1. **启用权限缓存**：减少权限检查开销
2. **批量权限检查**：使用 `checkMany()` 一次性检查多个权限
3. **异步处理**：充分利用异步特性提高并发性能
4. **连接池**：数据库连接池优化

---

**继续学习：** [@mtpc/adapter-drizzle](/docs/packages/adapter-drizzle) →
