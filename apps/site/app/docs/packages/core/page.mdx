---
title: mtpc/core 核心包
description: 详细介绍 MTPC 核心包的所有功能、API 和使用方法
---

# @mtpc/core 核心包

`@mtpc/core` 是 MTPC 的核心包，提供多租户权限的基础能力。

## 包概述

### 职责和定位

- 提供 Resource、Permission、Policy、Tenant 等核心抽象
- 提供 Registry 机制用于资源、权限、策略的注册
- 提供 Hooks 系统用于资源生命周期扩展
- 提供 Plugin 系统用于能力扩展

### 依赖关系

```json
{
  "dependencies": {
    "@mtpc/shared": "workspace:*",
    "zod": "^3.23.0"
  }
}
```

### 安装方法

```bash
npm install @mtpc/core
```

## 核心概念

### Resource（资源）

Resource 是 MTPC 的核心抽象，表示一个"可受权限控制的对象集合"。

#### ResourceDefinition 接口

```ts
interface ResourceDefinition<
  TName extends string,
  TSchema extends AnyZodSchema,
  TCreateSchema extends AnyZodSchema,
  TUpdateSchema extends AnyZodSchema
> {
  readonly name: TName;
  readonly schema: TSchema;
  readonly createSchema: TCreateSchema;
  readonly updateSchema: TUpdateSchema;
  readonly features: ResourceFeatures;
  readonly permissions: PermissionDefinition[];
  readonly hooks: ResourceHooks<InferSchema<TSchema>>;
  readonly relations: ResourceRelationDefinition[];
  readonly metadata: ResourceMetadata;
}
```

#### defineResource() 函数

```ts
function defineResource<
  const TName extends string,
  const TSchema extends AnyZodSchema,
  const TCreateSchema extends AnyZodSchema = TSchema,
  const TUpdateSchema extends AnyZodSchema = TSchema
>(
  input: ResourceDefinitionInput<TName, TSchema, TCreateSchema, TUpdateSchema>
): ResourceDefinition<TName, TSchema, TCreateSchema, TUpdateSchema>
```

**示例：**

```ts
import { defineResource } from '@mtpc/core'
import { z } from 'zod'

export const userResource = defineResource({
  name: 'user',
  schema: z.object({
    id: z.string(),
    name: z.string(),
    email: z.string().email(),
    role: z.enum(['admin', 'user', 'guest']),
  }),
  features: {
    creatable: true,
    readable: true,
    updatable: true,
    deletable: true,
    listable: true,
  },
  metadata: {
    displayName: '用户',
    pluralName: '用户列表',
    description: '系统用户管理',
  },
})
```

#### ResourceEntity 类型提取

```ts
type User = ResourceEntity<typeof userResource>
// 等价于：
// type User = {
//   id: string;
//   name: string;
//   email: string;
//   role: 'admin' | 'user' | 'guest';
// }
```

### Permission（权限）

Permission 是对 Resource 可执行操作的最小授权单元。

#### PermissionDefinition 接口

```ts
interface PermissionDefinition {
  action: PermissionAction;
  description?: string;
  scope?: PermissionScope;
  conditions?: PermissionCondition[];
  metadata?: Record<string, unknown>;
}
```

#### PermissionChecker 类

```ts
class PermissionChecker {
  constructor(
    resolver: (tenantId: string, subjectId: string) => Promise<Set<string>>
  )
  
  async check(context: PermissionCheckContext): Promise<PermissionCheckResult>
  async checkOrThrow(context: PermissionCheckContext): Promise<void>
  async checkMany(
    contexts: PermissionCheckContext[],
    options?: { parallel?: boolean; maxConcurrency?: number }
  ): Promise<BatchPermissionCheckResult>
  async hasAny(
    context: Omit<PermissionCheckContext, 'resource' | 'action'>,
    permissions: string[]
  ): Promise<boolean>
  async hasAll(
    context: Omit<PermissionCheckContext, 'resource' | 'action'>,
    permissions: string[]
  ): Promise<boolean>
}
```

**示例：**

```ts
import { PermissionChecker } from '@mtpc/core'

const checker = new PermissionChecker(async (tenantId, subjectId) => {
  // 从数据库或缓存获取权限集合
  return await getPermissionsFromDB(tenantId, subjectId)
})

// 检查权限
const result = await checker.check({
  tenant: { id: 'tenant-001' },
  subject: { id: 'user-123', type: 'user' },
  resource: 'user',
  action: 'create',
})

if (result.allowed) {
  console.log('有权限')
} else {
  console.log('无权限:', result.reason)
}
```

### Policy（策略）

Policy 用于表达 **权限组合与条件规则**。

#### PolicyDefinition 接口

```ts
interface PolicyDefinition {
  id: string;
  name: string;
  description?: string;
  rules: PolicyRule[];
  priority: PolicyPriority;
  enabled: boolean;
  tenantId?: string;
  metadata?: Record<string, unknown>;
}
```

#### PolicyEngine 接口

```ts
interface PolicyEngine {
  evaluate(context: PolicyEvaluationContext): Promise<PolicyEvaluationResult>;
  addPolicy(policy: PolicyDefinition): void;
  removePolicy(policyId: string): void;
  getPolicy(policyId: string): PolicyDefinition | undefined;
  listPolicies(tenantId?: string): PolicyDefinition[];
  compile(policy: PolicyDefinition): CompiledPolicy;
}
```

**示例：**

```ts
import { createPolicyEngine } from '@mtpc/core'

const engine = createPolicyEngine()

// 添加策略
engine.addPolicy({
  id: 'working-hours',
  name: '工作时间策略',
  rules: [{
    permissions: ['*'],
    effect: 'allow',
    conditions: [{
      field: 'request.timestamp',
      operator: 'between',
      value: { start: '09:00', end: '18:00' }
    }]
  }],
  priority: 'normal',
  enabled: true,
})

// 评估策略
const result = await engine.evaluate({
  tenant: { id: 'tenant-001' },
  subject: { id: 'user-123', type: 'user' },
  request: { timestamp: new Date() },
  permission: { code: 'user:create', resource: 'user', action: 'create' },
})
```

### Tenant（租户）

Tenant 是多租户隔离的第一等公民。

#### TenantContext 接口

```ts
interface TenantContext {
  id: string;
  status?: string;
  metadata?: Record<string, unknown>;
}
```

**示例：**

```ts
const tenantContext: TenantContext = {
  id: 'tenant-001',
  status: 'active',
  metadata: {
    plan: 'enterprise',
    expiresAt: new Date('2025-12-31'),
  },
}
```

### Registry（注册表）

Registry 是 MTPC 的"运行时事实表"，负责集中管理。

#### UnifiedRegistry 类

```ts
class UnifiedRegistry {
  // 资源管理
  registerResource(resource: ResourceDefinition): void
  getResource(name: string): ResourceDefinition | undefined
  listResources(): ResourceDefinition[]
  
  // 权限管理
  registerPermission(permission: Permission): void
  getPermission(code: string): Permission | undefined
  listPermissions(): Permission[]
  
  // 策略管理
  registerPolicy(policy: PolicyDefinition): void
  getPolicy(id: string): PolicyDefinition | undefined
  listPolicies(tenantId?: string): PolicyDefinition[]
}
```

## Hooks 系统

### ResourceHooks 接口

```ts
interface ResourceHooks<TData> {
  beforeCreate?: (ctx: MTPCContext, data: unknown) => Promise<unknown>
  afterCreate?: (ctx: MTPCContext, data: TData) => Promise<void>
  beforeUpdate?: (ctx: MTPCContext, id: string, data: unknown) => Promise<unknown>
  afterUpdate?: (ctx: MTPCContext, id: string, data: TData) => Promise<void>
  beforeDelete?: (ctx: MTPCContext, id: string) => Promise<void>
  afterDelete?: (ctx: MTPCContext, id: string) => Promise<void>
  filterQuery?: (ctx: MTPCContext, query: unknown) => Promise<unknown>
}
```

**示例：**

```ts
import { defineResource } from '@mtpc/core'

export const userResource = defineResource({
  name: 'user',
  schema: userSchema,
  hooks: {
    beforeCreate: async (ctx, data) => {
      // 验证数据
      if (!data.email.includes('@company.com')) {
        throw new Error('仅允许公司邮箱')
      }
    },
    afterCreate: async (ctx, result) => {
      // 发送欢迎邮件
      await sendWelcomeEmail(result.email)
    },
  },
})
```

## Plugin 系统

### MTPCPlugin 接口

```ts
interface MTPCPlugin {
  name: string;
  install(registry: Registry): void;
  hooks?: Partial<ResourceHooks>;
}
```

**示例：**

```ts
import { createMTPC } from '@mtpc/core'

// 创建自定义插件
const myPlugin: MTPCPlugin = {
  name: 'my-plugin',
  install(registry) {
    // 注册自定义资源
    registry.registerResource(customResource)
  },
  hooks: {
    beforeCreate: async (ctx, data) => {
      // 自定义逻辑
    },
  },
}

// 使用插件
const mtpc = createMTPC()
mtpc.use(myPlugin)
await mtpc.init()
```

## API 参考

### createMTPC() 工厂函数

```ts
function createMTPC(options?: MTPCOptions): MTPC
```

**选项：**

```ts
interface MTPCOptions {
  defaultPermissionResolver?: (
    tenantId: string,
    subjectId: string
  ) => Promise<Set<string>>
}
```

**示例：**

```ts
import { createMTPC } from '@mtpc/core'

const mtpc = createMTPC({
  defaultPermissionResolver: async (tenantId, subjectId) => {
    // 自定义权限解析逻辑
    return await getPermissions(tenantId, subjectId)
  },
})

await mtpc.init()
```

### MTPC 类方法

```ts
class MTPC {
  // 资源管理
  registerResource(resource: ResourceDefinition): void
  getResource(name: string): ResourceDefinition | undefined
  listResources(): ResourceDefinition[]
  
  // 权限管理
  checkPermission(context: PermissionCheckContext): Promise<PermissionCheckResult>
  
  // 插件管理
  use(plugin: MTPCPlugin): void
  
  // 初始化
  init(): Promise<void>
  
  // 元数据导出
  exportMetadata(): MTPCMetadata
}
```

## 使用示例

### 创建 MTPC 实例

```ts
import { createMTPC } from '@mtpc/core'

const mtpc = createMTPC()
await mtpc.init()
```

### 定义资源

```ts
import { defineResource } from '@mtpc/core'
import { z } from 'zod'

export const productResource = defineResource({
  name: 'product',
  schema: z.object({
    id: z.string(),
    name: z.string(),
    price: z.number(),
    stock: z.number(),
  }),
  features: {
    creatable: true,
    readable: true,
    updatable: true,
    deletable: true,
    listable: true,
  },
  metadata: {
    displayName: '商品',
    pluralName: '商品列表',
  },
})
```

### 注册资源

```ts
mtpc.registerResource(productResource)
```

### 权限检查

```ts
const result = await mtpc.checkPermission({
  tenant: { id: 'tenant-001' },
  subject: { id: 'user-123', type: 'user' },
  resource: 'product',
  action: 'create',
})

if (result.allowed) {
  // 允许操作
} else {
  // 拒绝操作
  throw new Error('无权限')
}
```

### 使用插件

```ts
import { createMTPC } from '@mtpc/core'
import { createRBACPlugin } from '@mtpc/rbac'

// 创建 RBAC 插件
const rbacPlugin = createRBACPlugin()

// 创建 MTPC 实例并集成
const mtpc = createMTPC({
  defaultPermissionResolver: rbacPlugin.state.evaluator.getPermissions.bind(
    rbacPlugin.state.evaluator
  )
})

// 注册插件
mtpc.use(rbacPlugin)

await mtpc.init()
```

## 最佳实践

### 资源设计原则

1. **单一职责**：每个资源只负责一个业务实体
2. **合理粒度**：避免过细或过粗的资源划分
3. **关系清晰**：明确定义资源之间的关系

### 权限命名规范

- 使用 `resource:action` 格式
- action 使用动词：create、read、update、delete、list
- 自定义 action 使用清晰、简洁的名称

### 性能优化建议

1. **使用缓存**：启用权限缓存减少数据库查询
2. **批量检查**：使用 `checkMany()` 一次性检查多个权限
3. **异步处理**：利用异步特性提高并发性能

## 类型定义导出

```ts
// 核心类型
export * from './types/index.js'

// 资源相关
export * from './resource/index.js'

// 权限相关
export * from './permission/index.js'

// 策略相关
export * from './policy/index.js'

// 租户相关
export * from './tenant/index.js'

// 注册表相关
export * from './registry/index.js'

// 钩子相关
export * from './hooks/index.js'

// 插件相关
export * from './plugin/index.js'
```

---

**继续学习：** [@mtpc/rbac](/docs/packages/rbac) →
