---
title: mtpc/adapter-drizzle Drizzle ORM 适配器
description: 详细介绍 Drizzle ORM 适配器的功能、API 和使用方法
---

# @mtpc/adapter-drizzle Drizzle ORM 适配器

`@mtpc/adapter-drizzle` 提供 Drizzle ORM 的数据访问层，自动租户隔离、基础仓储模式、Schema 生成工具和数据库迁移系统。

## 包概述

### 职责和定位

- 提供 Drizzle ORM 的数据访问层
- 自动租户隔离
- 基础仓储模式
- Schema 生成工具
- 数据库迁移系统
- CRUD 处理器

### 为什么选择 Drizzle

- **类型安全**：完整的 TypeScript 支持
- **轻量级**：极小的包体积
- **高性能**：优化的查询性能
- **SQL 优先**：直接使用 SQL，不抽象查询语言
- **多数据库支持**：PostgreSQL、MySQL、SQLite、SQL Server 等

### 支持的数据库

- PostgreSQL
- MySQL
- SQLite
- SQL Server
- PlanetScale

### 依赖关系

```json
{
  "dependencies": {
    "@mtpc/core": "workspace:*",
    "@mtpc/shared": "workspace:*",
    "drizzle-orm": "^0.30.0",
    "zod": "^3.23.0"
  },
  "peerDependencies": {
    "drizzle-orm": "^0.30.0",
    "postgres": "^3.4.0"
  }
}
```

### 安装方法

```bash
npm install @mtpc/adapter-drizzle drizzle-orm postgres
```

## 核心功能

### 数据库连接

#### DatabaseConfig 接口

```ts
interface DatabaseConfig {
  connectionString: string;
  maxConnections?: number;
  idleTimeout?: number;
  ssl?: boolean | object;
}
```

#### createConnection() 函数

```ts
import { createConnection } from '@mtpc/adapter-drizzle/pg'

const db = createConnection({
  connectionString: 'postgres://user:password@localhost:5432/dbname',
  maxConnections: 10,
  idleTimeout: 20,
  ssl: false,
})
```

### Schema 生成

#### SchemaGenerationOptions

```ts
interface SchemaGenerationOptions {
  tenantColumn?: string;      // 默认 'tenant_id'
  timestamps?: boolean;       // 默认 true
  softDelete?: boolean;       // 默认 false
  auditFields?: boolean;      // 默认 false
}
```

#### generateSchema() 函数

```ts
import { generateSchema } from '@mtpc/adapter-drizzle/schema'
import { userResource } from './resources'

const schema = generateSchema(userResource, {
  tenantColumn: 'tenant_id',
  timestamps: true,
  softDelete: true,
  auditFields: true,
})

console.log(schema)
// {
//   tableName: 'users',
//   columns: [...],
//   indexes: [...],
// }
```

### Repository 模式

#### Repository 接口

```ts
interface Repository<T> {
  findById(ctx: MTPCContext, id: string): Promise<T | null>;
  findMany(ctx: MTPCContext, options?: QueryOptions): Promise<PaginatedResult<T>>;
  create(ctx: MTPCContext, data: Partial<T>): Promise<T>;
  update(ctx: MTPCContext, id: string, data: Partial<T>): Promise<T | null>;
  delete(ctx: MTPCContext, id: string): Promise<boolean>;
  count(ctx: MTPCContext, options?: QueryOptions): Promise<number>;
}
```

#### BaseRepository 类

```ts
class BaseRepository<T> implements Repository<T> {
  constructor(
    protected db: DrizzleDB,
    protected table: Table
  ) {}
  
  async findById(ctx: MTPCContext, id: string): Promise<T | null> {
    const result = await this.db
      .select()
      .from(this.table)
      .where(eq(this.table.id, id))
      .limit(1)
      .get()
    
    return result || null
  }
  
  async findMany(
    ctx: MTPCContext,
    options?: QueryOptions
  ): Promise<PaginatedResult<T>> {
    // 实现查询逻辑
  }
  
  async create(ctx: MTPCContext, data: Partial<T>): Promise<T> {
    const [result] = await this.db
      .insert(this.table)
      .values(data)
      .returning()
      .get()
    
    return result
  }
  
  async update(
    ctx: MTPCContext,
    id: string,
    data: Partial<T>
  ): Promise<T | null> {
    const [result] = await this.db
      .update(this.table)
      .set(data)
      .where(eq(this.table.id, id))
      .returning()
      .get()
    
    return result || null
  }
  
  async delete(ctx: MTPCContext, id: string): Promise<boolean> {
    const [result] = await this.db
      .delete(this.table)
      .where(eq(this.table.id, id))
      .returning()
      .get()
    
    return !!result
  }
  
  async count(
    ctx: MTPCContext,
    options?: QueryOptions
  ): Promise<number> {
    const [result] = await this.db
      .select({ count: sql`count(*)` })
      .from(this.table)
      .get()
    
    return Number(result.count)
  }
}
```

#### TenantRepository 类

```ts
class TenantRepository<T> extends BaseRepository<T> {
  async findMany(
    ctx: MTPCContext,
    options?: QueryOptions
  ): Promise<PaginatedResult<T>> {
    // 自动添加租户过滤
    const query = this.db
      .select()
      .from(this.table)
      .where(eq(this.table.tenantId, ctx.tenant.id))
    
    // 应用其他过滤和分页
    return await this.applyQueryOptions(query, options)
  }
  
  async create(ctx: MTPCContext, data: Partial<T>): Promise<T> {
    // 自动添加租户 ID
    const dataWithTenant = {
      ...data,
      tenantId: ctx.tenant.id,
    }
    
    return super.create(ctx, dataWithTenant)
  }
}
```

### 查询构建器

#### QueryBuilder 类

```ts
class QueryBuilder<T> {
  constructor(
    protected db: DrizzleDB,
    protected table: Table
  ) {}
  
  where(condition: SQL): this {
    this.query = this.query.where(condition)
    return this
  }
  
  orderBy(column: Column, direction?: 'asc' | 'desc'): this {
    this.query = this.query.orderBy(direction === 'desc' ? desc(column) : asc(column))
    return this
  }
  
  limit(count: number): this {
    this.query = this.query.limit(count)
    return this
  }
  
  offset(count: number): this {
    this.query = this.query.offset(count)
    return this
  }
  
  async execute(): Promise<T[]> {
    return await this.query.get()
  }
}
```

#### 查询选项

```ts
interface QueryOptions {
  page?: number;
  pageSize?: number;
  sort?: string;
  filter?: Record<string, unknown>;
}
```

### CRUD 处理器

#### CRUDHandler 接口

```ts
interface CRUDHandler<T> {
  list(ctx: MTPCContext, options: QueryOptions): Promise<PaginatedResult<T>>;
  create(ctx: MTPCContext, data: unknown): Promise<T>;
  read(ctx: MTPCContext, id: string): Promise<T | null>;
  update(ctx: MTPCContext, id: string, data: unknown): Promise<T | null>;
  delete(ctx: MTPCContext, id: string): Promise<boolean>;
}
```

#### createCRUDHandler() 函数

```ts
import { createCRUDHandler } from '@mtpc/adapter-drizzle/handler'

const handler = createCRUDHandler(repository)
```

## 数据库迁移

### 迁移系统概述

提供完整的数据库迁移系统，支持：

- 生成迁移文件
- 执行迁移
- 回滚迁移
- 迁移历史记录

### 生成迁移文件

```ts
import { generateMigration } from '@mtpc/adapter-drizzle/pg'

const migration = generateMigration({
  name: 'add_user_table',
  up: async (db) => {
    await db.schema.createTable(users, (table) => {
      table.id().varchar().primaryKey(),
      table.name().varchar().notNull(),
      table.email().varchar().notNull().unique(),
      table.tenantId().varchar().notNull(),
    })
  },
  down: async (db) => {
    await db.schema.dropTable(users)
  },
})

await migration.write('./migrations/001_add_user_table.sql')
```

### 执行迁移

```ts
import { runMigrations } from '@mtpc/adapter-drizzle/pg'

await runMigrations({
  migrationsDir: './migrations',
  db: database,
})
```

### 回滚迁移

```ts
import { rollbackMigration } from '@mtpc/adapter-drizzle/pg'

await rollbackMigration({
  migrationName: '001_add_user_table',
  db: database,
})
```

## 租户隔离

### 自动租户列

```ts
import { generateSchema } from '@mtpc/adapter-drizzle/schema'

const schema = generateSchema(userResource, {
  tenantColumn: 'tenant_id',  // 自动添加租户列
})

// 生成的 Schema 包含：
// tenant_id varchar NOT NULL
```

### 租户过滤

```ts
class TenantRepository<T> extends BaseRepository<T> {
  async findMany(
    ctx: MTPCContext,
    options?: QueryOptions
  ): Promise<PaginatedResult<T>> {
    // 自动添加租户过滤
    const query = this.db
      .select()
      .from(this.table)
      .where(eq(this.table.tenantId, ctx.tenant.id))
    
    return await this.applyQueryOptions(query, options)
  }
}
```

### 多租户数据隔离

```ts
// 所有查询自动包含租户过滤
const users = await userRepository.findMany(ctx, {
  page: 1,
  pageSize: 20,
})

// 生成的 SQL:
// SELECT * FROM users WHERE tenant_id = $1 LIMIT 20
```

## 类型安全

### 从 Zod Schema 生成类型

```ts
import { defineResource } from '@mtpc/core'
import { z } from 'zod'

export const userResource = defineResource({
  name: 'user',
  schema: z.object({
    id: z.string(),
    name: z.string(),
    email: z.string().email(),
  }),
})

// 自动生成类型
type User = ResourceEntity<typeof userResource>
```

### TypeScript 类型推导

```ts
import { Repository } from '@mtpc/adapter-drizzle'

interface UserRepository extends Repository<User> {
  findByEmail(email: string): Promise<User | null>
}

class DatabaseUserRepository implements UserRepository {
  async findByEmail(email: string): Promise<User | null> {
    const [user] = await this.db
      .select()
      .from(users)
      .where(eq(users.email, email))
      .limit(1)
      .get()
    
    return user || null
  }
}
```

## 使用示例

### 初始化数据库连接

```ts
import { createConnection } from '@mtpc/adapter-drizzle/pg'

const db = createConnection({
  connectionString: process.env.DATABASE_URL,
  maxConnections: 10,
})
```

### 定义资源和 Schema

```ts
import { defineResource } from '@mtpc/core'
import { generateSchema } from '@mtpc/adapter-drizzle/schema'
import { z } from 'zod'

export const userResource = defineResource({
  name: 'user',
  schema: z.object({
    id: z.string(),
    name: z.string(),
    email: z.string().email(),
    role: z.enum(['admin', 'user', 'guest']),
  }),
  features: {
    creatable: true,
    readable: true,
    updatable: true,
    deletable: true,
    listable: true,
  },
})

const userSchema = generateSchema(userResource, {
  tenantColumn: 'tenant_id',
  timestamps: true,
})
```

### 创建 Repository

```ts
import { createRepositoryFactory } from '@mtpc/adapter-drizzle/repository'

const userRepository = createRepositoryFactory(db, users)
```

### 执行 CRUD 操作

```ts
import { MTPCContext } from '@mtpc/core'

const ctx: MTPCContext = {
  tenant: { id: 'tenant-001' },
  subject: { id: 'user-123', type: 'user' },
}

// 创建用户
const user = await userRepository.create(ctx, {
  name: 'John Doe',
  email: 'john@example.com',
  role: 'user',
})

// 查询用户
const foundUser = await userRepository.findById(ctx, user.id)

// 列出用户
const result = await userRepository.findMany(ctx, {
  page: 1,
  pageSize: 20,
})

// 更新用户
const updatedUser = await userRepository.update(ctx, user.id, {
  name: 'Jane Doe',
})

// 删除用户
const deleted = await userRepository.delete(ctx, user.id)
```

### 集成到 Hono 应用

```ts
import { createMTPC } from '@mtpc/core'
import { createMTPCApp } from '@mtpc/adapter-hono'
import { createRepositoryFactory } from '@mtpc/adapter-drizzle/repository'
import { createCRUDHandler } from '@mtpc/adapter-drizzle/handler'

// 创建数据库连接
const db = createConnection({
  connectionString: process.env.DATABASE_URL,
})

// 创建 Repository
const userRepository = createRepositoryFactory(db, users)

// 创建 MTPC 实例
const mtpc = createMTPC()
await mtpc.init()

// 创建 Hono 应用
const app = createMTPCApp(mtpc, {
  handlerFactory: (resource) => createCRUDHandler(
    createRepositoryFactory(db, getTableForResource(resource))
  ),
})

export default app
```

## 最佳实践

### Schema 设计原则

1. **命名规范**：使用蛇形命名（snake_case）
2. **索引优化**：为常用查询字段添加索引
3. **外键约束**：明确定义外键关系
4. **默认值**：为必填字段设置合理的默认值

### 索引优化

```ts
// 为常用查询字段添加索引
export const users = pgTable(
  'users',
  {
    id: varchar('id', { length: 256 }).primaryKey(),
    tenantId: varchar('tenant_id', { length: 256 }).notNull(),
    email: varchar('email', { length: 256 }).notNull(),
    // 添加索引
  },
  (table) => ({
    tenantIdIdx: index('tenant_id_idx').on(table.tenantId),
    emailIdx: index('email_idx').on(table.email),
  })
)
```

### 查询性能优化

1. **使用索引**：确保查询使用索引
2. **限制返回字段**：只选择需要的字段
3. **分页查询**：使用 LIMIT 和 OFFSET
4. **批量操作**：使用批量插入/更新减少数据库往返

---

**继续学习：** [官方扩展](/docs/extensions) →
